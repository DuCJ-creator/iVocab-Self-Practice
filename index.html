<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocab Self‑Practice — styled</title>
<style>
  /* =====================
     Design-only upgrades
     (No JS logic changed)
     ===================== */
  :root{
    --base-font: clamp(16px, 1.2vw + 0.6rem, 20px);
    --h1-size: clamp(24px, 2.6vw + .6rem, 38px);
    --h2-size: clamp(18px, 1.8vw + .6rem, 26px);
    --question-size: clamp(22px, 2.2vw + .8rem, 34px);
    --hint-size: clamp(13px, .6vw + .5rem, 18px);
    --btn-pad: clamp(10px, 1.2vw, 16px);
    --radius: 16px;
    --card-radius: 18px;
    --ring: 3px;
  }
  *{box-sizing:border-box;font-family:Segoe UI,system-ui,-apple-system,Roboto,Helvetica,Arial,sans-serif}
  html,body{height:100%}
  body{
    margin:0; padding:20px; min-height:100vh;
    background: radial-gradient(1200px 800px at 10% -10%, #7f8ff4 0%, transparent 60%),
                radial-gradient(1200px 800px at 110% 10%, #70e1f5 0%, transparent 60%),
                linear-gradient(135deg,#6a11cb 0%, #2575fc 100%);
    font-size:var(--base-font);
  }
  .container{max-width:min(100%,980px);margin:0 auto}
  .app-card{
    background:#fff; padding:28px 26px 42px; border-radius:var(--card-radius);
    box-shadow:0 18px 60px rgba(20,30,70,.20), 0 4px 14px rgba(20,30,70,.12);
  }
  h1{
    margin:0 0 18px; font-size:var(--h1-size); line-height:1.15; text-align:center; font-weight:800;
    letter-spacing:.2px;
    background:linear-gradient(90deg,#2575fc,#6a11cb); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  h2{font-size:var(--h2-size); margin:.75em 0 .5em; font-weight:700; color:#1f2a44}

  /* Sections toggling */
  .section{display:none;margin-top:12px}
  .section.active{display:block}
  .quiz-section,.result-section{display:none}
  .quiz-section.active,.result-section.active{display:block}

  textarea,input,select,button{
    width:100%; font-size:1em; padding:12px; border:1px solid #d7dbe3; border-radius:12px; margin:8px 0; background:#fff
  }
  textarea{min-height:9lh}

  /* Buttons */
  .button-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
  .button-group button{flex:1; min-width:160px; border:0; color:#fff; font-weight:800; cursor:pointer; border-radius:14px; padding:var(--btn-pad); letter-spacing:.2px; transition:transform .06s ease, box-shadow .2s ease, filter .2s}
  .button-group button:active{transform:translateY(1px)}
  .button-group button:focus-visible{outline:var(--ring) solid #2ec5fe; outline-offset:2px}
  .button-group button{
    background:linear-gradient(135deg,#2196F3,#21CBF3);
    box-shadow:0 10px 20px rgba(33,203,243,.25), 0 2px 6px rgba(33,150,243,.25);
  }
  .back-btn{background:linear-gradient(135deg,#9EA6B8,#6B7280)!important}
  .mode-btn{background:linear-gradient(135deg,#22c55e,#84cc16)!important}
  #continueToMode, #confirmUnitSelection, #confirmRangeSelection, #confirmFullSelection{background:linear-gradient(135deg,#8b5cf6,#6366f1)!important}

  /* Choice grid */
  .options{display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin-top:10px}
  .option{
    padding:18px 16px; border:2px solid #e8ebf3; border-radius:14px; background:#f7f9ff; cursor:pointer; position:relative;
    box-shadow:0 2px 8px rgba(35,48,86,.08); transition:box-shadow .2s, transform .06s ease, background .2s, border-color .2s
  }
  .option::after{
    content:""; position:absolute; inset:0; border-radius:inherit; box-shadow:inset 0 0 0 0 rgba(37,117,252,.0); transition:.2s
  }
  .option:hover{background:#eef3ff; border-color:#d5defb; box-shadow:0 10px 22px rgba(35,48,86,.12)}
  .option:active{transform:translateY(1px)}
  .option:focus-visible{outline:var(--ring) solid #60a5fa; outline-offset:2px}

  /* Question emphasis */
  .question{
    font-size:var(--question-size); line-height:1.25; font-weight:800; color:#0f172a; letter-spacing:.2px; margin:8px 0 4px
  }
  .hint{font-size:var(--hint-size); color:#64748b; margin:4px 0 8px}
  .timer{display:inline-flex; align-items:center; gap:8px; background:#fff3e0; color:#d35400; padding:8px 12px; border-radius:999px; margin:0 0 8px; font-weight:700; letter-spacing:.2px}
  .timer::before{content:"⏱"}

  /* Quiz shells */
  .quiz-shell{background:#ffffff; border:1px solid #e8ecf5; border-radius:18px; padding:20px; box-shadow:0 14px 44px rgba(20,30,70,.10)}
  .quiz-section h2{margin-top:0; color:#1f2a44}

  /* Results styling */
  #progressStats{font-weight:800; margin:8px 0 10px; color:#0f172a}
  #wordList{display:flex; flex-direction:column; gap:8px}
  #wordList > div{
    padding:10px 12px; border:1px dashed #d7dbe3; border-radius:12px; background:#fbfcff; font-size:1rem
  }

  /* Export/Modal */
  .export-modal,.print-form{display:none; position:fixed; inset:0; background:rgba(0,10,30,.55); z-index:9990; align-items:center; justify-content:center; padding:16px}
  .modal-content{background:#fff; border-radius:16px; max-width:560px; width:100%; padding:22px; box-shadow:0 18px 50px rgba(0,0,0,.25)}
  .modal-content h3{margin-top:0}

  /* Accessibility extras */
  button, .option { -webkit-tap-highlight-color: transparent }
  button:disabled{filter:grayscale(.6); cursor:not-allowed}

  /* Small helpers */
  .subtle{color:#64748b}

  /* Responsive tweaks */
  @media (max-width: 900px){
    .options{grid-template-columns:1fr}
    .button-group button{min-width:140px}
    .app-card{padding:22px 18px 28px}
  }
  @media (pointer: coarse){ .option{padding:22px} button{padding:calc(var(--btn-pad) + 4px)} }
</style>
</head>
<body>
  <div class="container">
    <div class="app-card">
      <h1>Shirley's Vocab Online Self‑Practice</h1>

      <!-- step 1 -->
      <div id="step1" class="section active">
        <h2>Start</h2>
        <p class="subtle">Choose how you want to provide your words.</p>
        <div class="button-group">
          <button id="useOwnWords">Enter My Own Words</button>
          <button id="useVocabBank">Use Vocabulary Bank</button>
        </div>
      </div>

      <!-- step 2a: own words -->
      <div id="step2a" class="section">
        <h2>Enter Your Words</h2>
        <p class="subtle">每行一筆，可用 <strong>TAB</strong> 或空白分隔。</p>
        <textarea id="wordInput" rows="8" placeholder="每行一筆，可用 TAB 或空白分隔：\nword\tPOS\tmeaning\nmock\tn.\t嘲弄;笑柄;仿製品;模擬考"></textarea>
        <div class="button-group">
          <button class="back-btn" id="backToStep1a">← Back</button>
          <button class="mode-btn" id="startOwnrecognition">recognition</button>
          <button class="mode-btn" id="startOwnSpelling">Spelling</button>
          <button class="mode-btn" id="startOwnDictation">Dictation</button>
        </div>
      </div>

      <!-- step 2b: vocab bank -->
      <div id="step2b" class="section">
        <h2>Select Vocabulary Level</h2>
        <select id="levelSelect"><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option><option value="6">Level 6</option></select>
        <div class="button-group">
          <button class="back-btn" id="backToStep1b">← Back</button>
          <button id="continueToMode">Continue →</button>
        </div>
      </div>

      <!-- step 3: choose practice shape -->
      <div id="step3" class="section">
        <h2>Select Practice Mode</h2>
        <div class="button-group">
          <button id="unitMode">Unit Practice</button>
          <button id="rangeMode">Range Practice</button>
          <button id="fullMode">Full Level Mix</button>
        </div>
        <button class="back-btn" id="backToLevel">← Back to Level</button>
      </div>

      <!-- unit mode -->
      <div id="unitModeSection" class="section">
        <h2>Select Units (1–50)</h2>
        <select id="unitSelect" size="10" multiple style="height:220px"></select>
        <div class="button-group">
          <button class="back-btn" id="backToModeFromUnit">← Back</button>
          <button id="confirmUnitSelection">Confirm Selection</button>
        </div>
      </div>

      <!-- range mode -->
      <div id="rangeModeSection" class="section">
        <h2>Select Range & Count</h2>
        <select id="rangeSelect">
          <option>1-5</option>
          <option>6-10</option>
          <option>11-15</option>
          <option>16-20</option>
          <option>21-25</option>
          <option>26-30</option>
          <option>31-35</option>
          <option>36-40</option>
          <option>41-45</option>
          <option>46-50</option>
        </select>
        <select id="rangeWordCount">
          <option>10</option>
          <option>20</option>
          <option>30</option>
          <option>50</option>
          <option>100</option>
          <option value="all">All</option>
        </select>
        <div class="button-group">
          <button class="back-btn" id="backToModeFromRange">← Back</button>
          <button id="confirmRangeSelection">Start Practice</button>
        </div>
      </div>

      <!-- full mode -->
      <div id="fullModeSection" class="section">
        <h2>Full Level Practice</h2>
        <select id="fullWordCount">
          <option>10</option>
          <option>20</option>
          <option>30</option>
          <option>50</option>
          <option>100</option>
          <option value="all">All</option>
        </select>
        <div class="button-group">
          <button class="back-btn" id="backToModeFromFull">← Back</button>
          <button id="confirmFullSelection">Start Practice</button>
        </div>
      </div>

      <!-- recognition -->
      <div id="recognitionQuiz" class="quiz-section">
        <div class="quiz-shell">
          <h2>recognition Mode</h2>
          <div id="recognitionTimer" class="timer">Time left: 8s</div>
          <div id="recognitionQuestion" class="question"></div>
          <div class="hint subtle">Choose the correct meaning</div>
          <div id="recognitionOptions" class="options"></div>
          <div id="recognitionResult" class="hint" aria-live="polite"></div>
        </div>
      </div>

      <!-- spelling -->
      <div id="spellingQuiz" class="quiz-section">
        <div class="quiz-shell">
          <h2>Spelling Practice</h2>
          <div id="spellingQuestion" class="question"></div>
          <div id="spellingHint" class="hint"></div>
          <input id="spellingInput" class="spelling-input" placeholder="Type the word" />
          <div class="button-group" style="margin-top:6px">
            <button id="spellingNext">Next</button>
          </div>
          <div id="spellingResult" class="hint" aria-live="polite"></div>
        </div>
      </div>

      <!-- dictation -->
      <div id="dictationQuiz" class="quiz-section">
        <div class="quiz-shell">
          <h2>Dictation Practice</h2>
          <div id="dictationQuestion" class="question"></div>
          <div id="dictationHint" class="hint"></div>
          <div class="button-group" style="margin-top:6px">
            <button id="playAudio">Play Audio</button>
          </div>
          <input id="dictationInput" class="dictation-input" placeholder="Type what you hear" />
          <div class="button-group" style="margin-top:6px">
            <button id="dictationNext">Next</button>
          </div>
          <div id="dictationResult" class="hint" aria-live="polite"></div>
        </div>
      </div>

      <!-- results -->
      <div id="resultSection" class="result-section">
        <div class="quiz-shell">
          <h2>Practice Results</h2>
          <div id="progressStats"></div>
          <div id="wordList"></div>
          <div class="button-group" style="margin-top:12px">
            <button id="downloadTextTop">Export Report (.txt)</button>
            <button id="copyToClipboardTop">Copy Report</button>
            <button id="showPrintableTop">Print Report</button>
            <button id="exportResults">More Export Options</button>
            <button id="retryWrong">Retry Wrong Words</button>
            <button class="back-btn" id="backToInput">Back to Input</button>
          </div>
        </div>
      </div>

      <!-- Export Modal -->
      <div class="export-modal" id="exportOptions">
        <div class="modal-content">
          <h3>Export Results</h3>
          <div class="button-group">
            <button id="copyToClipboard">Copy to Clipboard</button>
            <button id="downloadText">Download as .txt</button>
            <button id="showPrintable">Printable Version</button>
          </div>
          <button class="back-btn" id="closeExport">Close</button>
        </div>
      </div>

      <!-- Print Form Modal -->
      <div class="print-form" id="printForm">
        <div class="modal-content">
          <h3>Print Info</h3>
          <input type="text" id="className" placeholder="Class" />
          <input type="text" id="seatNo" placeholder="Seat No" />
          <input type="text" id="studentName" placeholder="Name" />
          <div class="button-group">
            <button class="mode-btn" id="submitPrintInfo">Confirm</button>
            <button class="back-btn" id="closePrintForm">Cancel</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
// ===== Error catcher so我們能看到真正錯誤 =====
window.addEventListener('error', (e)=>{ alert('JS Error: '+ e.message); });
window.addEventListener('unhandledrejection', (e)=>{ alert('Promise rejection: '+ (e.reason && (e.reason.message||e.reason) || e)); });

// ===== Basic helpers =====
function refTag(w){
  if (!w) return '';
  return w.source === 'bank' 
    ? ` [L${w.Level}-U${w.Unit}-${w.No}]` 
    : ' [self-input]';
}
const $ = (id)=> document.getElementById(id);
const on = (id, ev, fn)=> { const el=$(id); if(!el){ console.warn('Missing #'+id); return; } el.addEventListener(ev, fn); };

// ===== State =====
let wordList = [], currentMode='', currentIndex=0, correctAnswers=0, wrongAnswers=[], userAnswers={}, timer=null, timeLeft=8; 
let loadedVocab = {}; window.printInfo={cls:'',seat:'',name:''};

const sections = {step1: $('step1'), step2a:$('step2a'), step2b:$('step2b'), step3:$('step3'), unitMode:$('unitModeSection'), rangeMode:$('rangeModeSection'), fullMode:$('fullModeSection'), recognition:$('recognitionQuiz'), spelling:$('spellingQuiz'), dictation:$('dictationQuiz'), result:$('resultSection')};

function hideAll(){ Object.values(sections).forEach(el=> el && el.classList.remove('active')); }
function showSection(id){ hideAll(); const el=$(id); if(el) el.classList.add('active'); }

function initUnitSelect(){ const s=$('unitSelect'); if(!s) return; s.innerHTML=''; for(let i=1;i<=50;i++){ const o=document.createElement('option'); o.value=i; o.textContent='Unit '+i; s.appendChild(o);} }

function parseOwnInput(text){
  return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{
    const tparts = line.split('\t').filter(Boolean);
    if(tparts.length>=3){ const [w,p,...rest]=tparts; return {Word:w.trim(), POS:p.trim(), Meaning:rest.join(' ').trim(), source:'own'}; }
    const m = line.match(/^(\S+)\s+(\S+)\s+(.+)$/); if(m){ return {Word:m[1], POS:m[2], Meaning:m[3], source:'own'}; }
    return null;
  }).filter(Boolean);
}

// ===== Own-words start =====
['recognition','Spelling','Dictation'].forEach(mode=>{
  on('startOwn'+mode, 'click', ()=>{
    const raw = $('wordInput').value.trim(); if(!raw){ alert('Please enter words!'); return; }
    wordList = parseOwnInput(raw); if(wordList.length===0){ alert('Invalid format'); return; }
    startPractice(mode.toLowerCase());
  });
});

// ===== Nav wiring =====
on('useOwnWords','click', ()=> showSection('step2a'));
on('useVocabBank','click', ()=> showSection('step2b'));
on('backToStep1a','click', ()=> showSection('step1'));
on('backToStep1b','click', ()=> showSection('step1'));
on('continueToMode','click', ()=> showSection('step3'));
on('backToLevel','click', ()=> showSection('step2b'));
on('unitMode','click', ()=> showSection('unitModeSection'));
on('rangeMode','click', ()=> showSection('rangeModeSection'));
on('fullMode','click', ()=> showSection('fullModeSection'));
on('backToModeFromUnit','click', ()=> showSection('step3'));
on('backToModeFromRange','click', ()=> showSection('step3'));
on('backToModeFromFull','click', ()=> showSection('step3'));

// ===== CSV (bank) =====
async function loadLevelCSV(level){
  if(loadedVocab['level'+level]) return loadedVocab['level'+level];
  const res = await fetch('level'+level+'.csv').catch(()=>null);
  if(!res || !res.ok){ alert('Cannot load level'+level+'.csv — place CSV next to this HTML (same origin).'); return []; }
  const text = await res.text();
  const lines = text.trim().split(/\r?\n/);
  const data = lines.slice(1).map(line=>{ const p=line.split(','); if(p.length<6) return null; return {Level:p[0],Unit:p[1],No:p[2],Word:p[3],POS:p[4],Meaning:p.slice(5).join(','),source:'bank'}; }).filter(Boolean);
  loadedVocab['level'+level]=data; return data;
}
function pick(arr,n){ const a=[...arr]; a.sort(()=>0.5-Math.random()); return a.slice(0, Math.min(n,a.length)); }
function selectFromBank(level, mode, opt){
  const all = loadedVocab['level'+level] || [];
  if (mode === 'unit') {
    const us = opt.units.map(String);
    return all.filter(w => us.includes(w.Unit));
  }
  if (mode === 'range') {
    const [s, e] = opt.range.split('-').map(Number);
    const r = all.filter(w => {
      const u = +w.Unit;
      return u >= s && u <= e;
    });
    if (opt.count === 'all') {
      return r;
    } else {
      return pick(r, opt.count);
    }
  }
  if (mode === 'full') {
    if (opt.count === 'all') {
      return all;
    } else {
      return pick(all, opt.count);
    }
  }
  return [];
}

on('confirmUnitSelection','click', async ()=>{
  const level=$('levelSelect').value;
  await loadLevelCSV(level);
  const sel=[...$('unitSelect').selectedOptions].map(o=>o.value);
  if(sel.length===0){ alert('Select at least one unit'); return;}
  wordList = selectFromBank(level,'unit',{units:sel});
  if(wordList.length===0){ alert('No words'); return;}
  showModeShortcuts();
});

on('confirmRangeSelection','click', async ()=>{
  const level = $('levelSelect').value;
  const range = $('rangeSelect').value;
  let count = $('rangeWordCount').value;
  if (count !== 'all') {
    count = parseInt(count, 10) || 10;
  }
  await loadLevelCSV(level);
  wordList = selectFromBank(level, 'range', {range, count});
  if (wordList.length === 0) {
    alert('No words found in this range.');
    return;
  }
  showModeShortcuts();
});

on('confirmFullSelection','click', async ()=>{
  const level = $('levelSelect').value;
  let count = $('fullWordCount').value;
  if (count !== 'all') {
    count = parseInt(count, 10) || 10;
  }
  await loadLevelCSV(level);
  wordList = selectFromBank(level, 'full', {count});
  if (wordList.length === 0) {
    alert('No words');
    return;
  }
  showModeShortcuts();
});

function showModeShortcuts(){
  showSection('step1');
  const existing=document.getElementById('tempModeBtns');
  if (existing) existing.remove();
  const div=document.createElement('div');
  div.id='tempModeBtns';
  div.innerHTML='<div class="button-group" style="margin-top:12px"><button class="mode-btn" id="temprecognition">recognition</button><button class="mode-btn" id="tempSpelling">Spelling</button><button class="mode-btn" id="tempDictation">Dictation</button></div>';
  const h1=document.querySelector('h1');
  h1.parentNode.insertBefore(div,h1.nextSibling);
  on('temprecognition','click', ()=>{div.remove(); startPractice('recognition');});
  on('tempSpelling','click', ()=>{div.remove(); startPractice('spelling');});
  on('tempDictation','click', ()=>{div.remove(); startPractice('dictation');});
}

// ===== Quizzes =====
function startPractice(mode){ currentMode=mode; currentIndex=0; correctAnswers=0; wrongAnswers=[]; userAnswers={}; showSection(mode+'Quiz'); if(mode==='recognition') startrecognition(); else if(mode==='spelling') startSpelling(); else if(mode==='dictation') startDictation(); }

function startrecognition(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('recognitionQuestion').textContent = `${w.Word} (${w.POS})${refTag(w)}`; $('recognitionResult').textContent=''; const opts = makeOptions(currentIndex); const box=$('recognitionOptions'); box.innerHTML=''; opts.forEach(o=>{ const el=document.createElement('div'); el.className='option'; el.textContent=o; el.onclick=()=>checkrecognition(o); box.appendChild(el); }); timeLeft=8; $('recognitionTimer').textContent='Time left: '+timeLeft+'s'; if(timer) clearInterval(timer); timer=setInterval(()=>{ timeLeft--; $('recognitionTimer').textContent='Time left: '+timeLeft+'s'; if(timeLeft<=0){ clearInterval(timer); $('recognitionResult').innerHTML='Time up! Correct: '+wordList[currentIndex].Meaning; wrongAnswers.push(currentIndex); currentIndex++; setTimeout(startrecognition, 800); } },1000); }

function makeOptions(i){ const correct=wordList[i].Meaning; const pool=wordList.filter((_,k)=>k!==i); const opts=[correct]; while(opts.length<4 && pool.length){ const r = pool[Math.floor(Math.random()*pool.length)]; if(!opts.includes(r.Meaning)) opts.push(r.Meaning); } return opts.sort(()=>0.5-Math.random()); }
function checkrecognition(ans){ clearInterval(timer); const correct=wordList[currentIndex].Meaning; if(ans===correct){ $('recognitionResult').textContent='Correct!'; correctAnswers++; } else { $('recognitionResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex); } currentIndex++; setTimeout(startrecognition,800); }

function startSpelling(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('spellingQuestion').textContent='Meaning: '+w.Meaning; $('spellingHint').textContent = `POS: ${w.POS} | First letter: ${w.Word[0].toUpperCase()}${refTag(w)}`; $('spellingInput').value=''; $('spellingResult').textContent=''; $('spellingInput').focus(); }
function checkSpelling(){ const user=$('spellingInput').value.trim(); const correct=wordList[currentIndex].Word; userAnswers[currentIndex]=user; if(user.toLowerCase()===correct.toLowerCase()){ $('spellingResult').textContent='Correct!'; correctAnswers++; } else { $('spellingResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex);} currentIndex++; setTimeout(startSpelling,700); }

function startDictation(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('dictationQuestion').textContent='Meaning: '+w.Meaning; $('dictationHint').textContent = `POS: ${w.POS}${refTag(w)}`; $('dictationInput').value=''; $('dictationResult').textContent=''; setTimeout(()=>{ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(w.Word); u.lang='en-US'; u.rate=.85; speechSynthesis.speak(u);} },300); }
function checkDictation(){ const user=$('dictationInput').value.trim(); const correct=wordList[currentIndex].Word; userAnswers[currentIndex]=user; if(user.toLowerCase()===correct.toLowerCase()){ $('dictationResult').textContent='Correct!'; correctAnswers++; } else { $('dictationResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex);} currentIndex++; setTimeout(startDictation,700); }

on('spellingNext','click', checkSpelling); on('dictationNext','click', checkDictation); on('spellingInput','keypress', e=>{ if(e.key==='Enter') checkSpelling(); }); on('dictationInput','keypress', e=>{ if(e.key==='Enter') checkDictation(); }); on('playAudio','click', ()=>{ const w=wordList[currentIndex]; if(!w) return; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(w.Word); u.lang='en-US'; u.rate=.85; speechSynthesis.speak(u);} });

function showResults(){ showSection('resultSection'); $('progressStats').textContent=`Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}`; const list=$('wordList'); list.innerHTML=''; wordList.forEach((w,i)=>{ const row=document.createElement('div'); row.textContent = `${wrongAnswers.includes(i)?'✗':'✓'}  ${w.Word} (${w.POS})${refTag(w)} — ${w.Meaning}`; list.appendChild(row); }); }

on('retryWrong','click', ()=>{ if(wrongAnswers.length===0){ alert('No wrong words!'); return; } wordList = wrongAnswers.map(i=>wordList[i]); currentIndex=0; correctAnswers=0; wrongAnswers=[]; userAnswers={}; showSection(currentMode+'Quiz'); if(currentMode==='recognition') startrecognition(); else if(currentMode==='spelling') startSpelling(); else if(currentMode==='dictation') startDictation(); });

// ===== Export helpers =====
function buildResultsText(){
  const lines = [
    `Mode: ${currentMode}`,
    `Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}`,
    ''.padEnd(10,'-')
  ];
  wordList.forEach((w,i)=>{
    const mark = wrongAnswers.includes(i)?'✗':'✓';
    const ans = (currentMode!=='recognition' && userAnswers[i]) ? ` | Your answer: ${userAnswers[i]}` : '';
    lines.push(`${mark} ${w.Word} (${w.POS})${refTag(w)} — ${w.Meaning}${ans}`);
  });
  return lines.join('\n');
}
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000); }
function generatePrintable(){
  const date = new Date().toLocaleDateString('en-US');
  const map = {recognition:'recognition', spelling:'Spelling', dictation:'Dictation'};
  const rows = wordList.map((w,i)=>{
    const mark = wrongAnswers.includes(i)?'✗':'✓';
    const ans = currentMode!=='recognition' ? `<td>${userAnswers[i]||''}</td>` : '';
    return `<tr><td>${w.Word}${refTag(w)}</td><td>${w.POS}</td><td>${w.Meaning}</td>${ans}<td>${mark}</td></tr>`;
  }).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Results</title><style>body{font-family:Arial, sans-serif;margin:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px}th{background:#f5f5f5}@media print{button{display:none}}</style></head><body>
  <h2>Vocabulary Practice Results</h2>
  <p><strong>Class:</strong> ${window.printInfo.cls} | <strong>Seat:</strong> ${window.printInfo.seat} | <strong>Name:</strong> ${window.printInfo.name}</p>
  <p>Date: ${date} | Mode: ${map[currentMode]||currentMode}</p>
  <p>Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}</p>
  <table><thead><tr><th>Word</th><th>POS</th><th>Meaning</th>${currentMode!=='recognition'?'<th>Your Answer</th>':''}<th>Result</th></tr></thead><tbody>${rows}</tbody></table>
  <br><button onclick="window.print()">Print</button> <button onclick="(function(){try{window.close()}catch(e){} try{history.back()}catch(e){}})()">Back</button> <button onclick="window.close()">Close</button>
  </body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}

// Export bindings (top row)
on('downloadTextTop','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} download('vocab_results.txt', buildResultsText()); });
on('copyToClipboardTop','click', async ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const txt=buildResultsText(); try{ await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); }catch{ alert('Copy failed. Please use Download .txt'); } });
on('showPrintableTop','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const pf=$('printForm'); if(pf) pf.style.display='flex'; });
// Back to Input safety: close any modals then go step1
on('backToInput','click', ()=>{
  const eo = $('exportOptions');
  if (eo) eo.style.display = 'none';
  const pf = $('printForm');
  if (pf) pf.style.display = 'none';
  const t = document.getElementById('tempModeBtns');
  if (t) t.remove();
  showSection('step1');
  window.scrollTo(0, 0);
});

// Modal export (optional)
on('exportResults','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const m=$('exportOptions'); if(m) m.style.display='flex'; });
on('closeExport','click', ()=>{ const m=$('exportOptions'); if(m) m.style.display='none'; });
on('copyToClipboard','click', async ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const txt=buildResultsText(); try{ await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); }catch{ alert('Copy failed. Please use Download .txt'); } });
on('downloadText','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} download('vocab_results.txt', buildResultsText()); });
on('showPrintable','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const m=$('exportOptions'); if(m) m.style.display='none'; const pf=$('printForm'); if(pf) pf.style.display='flex'; });
on('closePrintForm','click', ()=>{ const pf=$('printForm'); if(pf) pf.style.display='none'; });
on('submitPrintInfo','click', ()=>{ if(!wordList.length){ alert('Finish a practice first.'); return;} const cls=$('className').value.trim(); const seat=$('seatNo').value.trim(); const name=$('studentName').value.trim(); if(!cls||!seat||!name){ alert('Please fill in all fields.'); return; } window.printInfo={cls,seat,name}; $('printForm').style.display='none'; generatePrintable(); });

// ===== boot =====
initUnitSelect();
console.log('[boot] ready');
</script>
</body>
</html>
