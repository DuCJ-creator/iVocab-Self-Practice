<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vocab Self-Practice — minimal fixed</title>
<style>
  :root{
    --base-font: clamp(16px, 1.2vw + 0.6rem, 20px);
    --h1-size: clamp(22px, 2.6vw + .6rem, 36px);
    --h2-size: clamp(18px, 1.8vw + .6rem, 26px);
    --btn-pad: clamp(10px, 1.2vw, 16px);
    --radius: 12px;
  }
  *{box-sizing:border-box;font-family:Segoe UI,system-ui,sans-serif}
  html,body{height:100%}
  body{margin:0;padding:20px;min-height:100vh;background:linear-gradient(135deg,#6a11cb,#2575fc);font-size:var(--base-font);}
  .container{max-width: min(100%, 980px);margin:0 auto;background:#fff;padding:24px 24px 40px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  h1{margin:0 0 16px;font-size:var(--h1-size);line-height:1.2;background:linear-gradient(90deg,#2575fc,#6a11cb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
  h2{font-size:var(--h2-size);margin:.6em 0}
  .section{display:none;margin-top:12px}
  .section.active{display:block}
  .quiz-section,.result-section{display:none}
  .quiz-section.active,.result-section.active{display:block}
  textarea,input,select,button{width:100%;font-size:1em;padding:12px;border:1px solid #ccc;border-radius:var(--radius);margin:8px 0}
  textarea{min-height:8lh}
  .button-group{display:flex;gap:12px;flex-wrap:wrap}
  .button-group button{flex:1;min-width:160px;border:0;background:linear-gradient(135deg,#2196F3,#21CBF3);color:#fff;font-weight:700;cursor:pointer;border-radius:calc(var(--radius) + 2px);padding:var(--btn-pad)}
  .back-btn{background:#9E9E9E!important}
  .mode-btn{background:linear-gradient(135deg,#4CAF50,#8BC34A)!important}
  .options{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .option{padding:16px;border:2px solid #ddd;border-radius:10px;background:#f0f0f0;cursor:pointer}
  .timer{display:inline-block;background:#fff3e0;color:#ff5722;padding:6px 10px;border-radius:8px;margin-bottom:8px}

  /* Export / Print modals */
  .export-modal,.print-form{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9990;align-items:center;justify-content:center;padding:16px}
  .modal-content{background:#fff;border-radius:16px;max-width:560px;width:100%;padding:20px}
  .modal-content h3{margin-top:0}

  /* Responsive tweaks */
  @media (max-width: 900px){ .options{grid-template-columns:1fr} .button-group button{min-width:140px} }
  @media (pointer: coarse){ .option{padding:20px} button{padding:calc(var(--btn-pad) + 4px)} }
</style>
</head>
<body>
<div class="container">
  <h1>Shirley's Vocab Online Self‑Practice</h1>
  <!-- step 1 -->
  <div id="step1" class="section active">
    <h2>Select Word Source</h2>
    <div class="button-group">
      <button id="useOwnWords">Enter My Own Words</button>
      <button id="useVocabBank">Use Vocabulary Bank</button>
    </div>
  </div>

  <!-- step 2a: own words -->
  <div id="step2a" class="section">
    <h2>Enter Your Words</h2>
    <textarea id="wordInput" rows="8" placeholder="每行一筆，可用 TAB 或空白分隔：\nword\tPOS\tmeaning\nmock\tn.\t嘲弄;笑柄;仿製品;模擬考"></textarea>
    <div class="button-group">
      <button class="back-btn" id="backToStep1a">← Back</button>
      <button class="mode-btn" id="startOwnCognition">Cognition</button>
      <button class="mode-btn" id="startOwnSpelling">Spelling</button>
      <button class="mode-btn" id="startOwnDictation">Dictation</button>
    </div>
  </div>

  <!-- step 2b: vocab bank -->
  <div id="step2b" class="section">
    <h2>Select Vocabulary Level</h2>
    <select id="levelSelect"><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option><option value="6">Level 6</option></select>
    <div class="button-group">
      <button class="back-btn" id="backToStep1b">← Back</button>
      <button id="continueToMode">Continue →</button>
    </div>
  </div>

  <!-- step 3: choose practice shape -->
  <div id="step3" class="section">
    <h2>Select Practice Mode</h2>
    <div class="button-group">
      <button id="unitMode">Unit Practice</button>
      <button id="rangeMode">Range Practice</button>
      <button id="fullMode">Full Level Mix</button>
    </div>
    <button class="back-btn" id="backToLevel">← Back to Level</button>
  </div>

  <!-- unit mode -->
  <div id="unitModeSection" class="section">
    <h2>Select Units (1–50)</h2>
    <select id="unitSelect" size="10" multiple style="height:200px"></select>
    <div class="button-group">
      <button class="back-btn" id="backToModeFromUnit">← Back</button>
      <button id="confirmUnitSelection">Confirm Selection</button>
    </div>
  </div>

  <!-- range mode -->
  <div id="rangeModeSection" class="section">
    <h2>Select Range & Count</h2>
    <select id="rangeSelect"><option>1-10</option><option>11-20</option><option>21-30</option><option>31-40</option><option>41-50</option></select>
    <select id="rangeWordCount"><option>10</option><option>20</option><option>30</option></select>
    <div class="button-group">
      <button class="back-btn" id="backToModeFromRange">← Back</button>
      <button id="confirmRangeSelection">Start Practice</button>
    </div>
  </div>

  <!-- full mode -->
  <div id="fullModeSection" class="section">
    <h2>Full Level Practice</h2>
    <select id="fullWordCount"><option>10</option><option>20</option><option>30</option></select>
    <div class="button-group">
      <button class="back-btn" id="backToModeFromFull">← Back</button>
      <button id="confirmFullSelection">Start Practice</button>
    </div>
  </div>

  <!-- cognition -->
  <div id="cognitionQuiz" class="quiz-section">
    <h2>Cognition Mode</h2>
    <div id="cognitionTimer" class="timer">Time left: 8s</div>
    <div id="cognitionQuestion" class="question"></div>
    <div id="cognitionOptions" class="options"></div>
    <div id="cognitionResult"></div>
  </div>

  <!-- spelling -->
  <div id="spellingQuiz" class="quiz-section">
    <h2>Spelling Practice</h2>
    <div id="spellingQuestion" class="question"></div>
    <div id="spellingHint" class="hint"></div>
    <input id="spellingInput" class="spelling-input" placeholder="Type the word" />
    <button id="spellingNext">Next</button>
    <div id="spellingResult"></div>
  </div>

  <!-- dictation -->
  <div id="dictationQuiz" class="quiz-section">
    <h2>Dictation Practice</h2>
    <div id="dictationQuestion" class="question"></div>
    <div id="dictationHint" class="hint"></div>
    <button id="playAudio">Play Audio</button>
    <input id="dictationInput" class="dictation-input" placeholder="Type what you hear" />
    <button id="dictationNext">Next</button>
    <div id="dictationResult"></div>
  </div>

  <!-- results -->
  <div id="resultSection" class="result-section">
    <h2>Practice Results</h2>
    <div id="progressStats"></div>
    <div id="wordList"></div>
    <div class="button-group">
      <button id="exportResults">Export Results</button>
      <button id="retryWrong">Retry Wrong Words</button>
      <button class="back-btn" id="backToInput">Back to Input</button>
    </div>
  </div>
  <!-- Export Modal -->
  <div class="export-modal" id="exportOptions">
    <div class="modal-content">
      <h3>Export Results</h3>
      <div class="button-group">
        <button id="copyToClipboard">Copy to Clipboard</button>
        <button id="downloadText">Download as .txt</button>
        <button id="showPrintable">Printable Version</button>
      </div>
      <button class="back-btn" id="closeExport">Close</button>
    </div>
  </div>

  <!-- Print Form Modal -->
  <div class="print-form" id="printForm">
    <div class="modal-content">
      <h3>Print Info</h3>
      <input type="text" id="className" placeholder="Class" />
      <input type="text" id="seatNo" placeholder="Seat No" />
      <input type="text" id="studentName" placeholder="Name" />
      <div class="button-group">
        <button class="mode-btn" id="submitPrintInfo">Confirm</button>
        <button class="back-btn" id="closePrintForm">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Basic helpers =====
const $ = (id)=> document.getElementById(id);
const on = (id, ev, fn)=> { const el=$(id); if(!el){ console.warn('Missing #'+id); return; } el.addEventListener(ev, fn); };

// ===== State =====
let wordList = [], currentMode='', currentIndex=0, correctAnswers=0, wrongAnswers=[], userAnswers={}, timer=null, timeLeft=8; 
let loadedVocab = {}; window.printInfo={cls:'',seat:'',name:''};

const sections = {step1: $('step1'), step2a:$('step2a'), step2b:$('step2b'), step3:$('step3'), unitMode:$('unitModeSection'), rangeMode:$('rangeModeSection'), fullMode:$('fullModeSection'), cognition:$('cognitionQuiz'), spelling:$('spellingQuiz'), dictation:$('dictationQuiz'), result:$('resultSection')};

function hideAll(){ Object.values(sections).forEach(el=> el && el.classList.remove('active')); }
function showSection(id){ hideAll(); const el=$(id); if(el) el.classList.add('active'); }

function initUnitSelect(){ const s=$('unitSelect'); if(!s) return; s.innerHTML=''; for(let i=1;i<=50;i++){ const o=document.createElement('option'); o.value=i; o.textContent='Unit '+i; s.appendChild(o);} }

function parseOwnInput(text){
  return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{
    const tparts = line.split('\t').filter(Boolean);
    if(tparts.length>=3){ const [w,p,...rest]=tparts; return {Word:w.trim(), POS:p.trim(), Meaning:rest.join(' ').trim(), source:'own'}; }
    const m = line.match(/^(\S+)\s+(\S+)\s+(.+)$/); if(m){ return {Word:m[1], POS:m[2], Meaning:m[3], source:'own'}; }
    return null;
  }).filter(Boolean);
}

// ===== Own-words start =====
['Cognition','Spelling','Dictation'].forEach(mode=>{
  on('startOwn'+mode, 'click', ()=>{
    const raw = $('wordInput').value.trim(); if(!raw){ alert('Please enter words!'); return; }
    wordList = parseOwnInput(raw); if(wordList.length===0){ alert('Invalid format'); return; }
    startPractice(mode.toLowerCase());
  });
});

// ===== Nav wiring =====
on('useOwnWords','click', ()=> showSection('step2a'));
on('useVocabBank','click', ()=> showSection('step2b'));
on('backToStep1a','click', ()=> showSection('step1'));
on('backToStep1b','click', ()=> showSection('step1'));
on('continueToMode','click', ()=> showSection('step3'));
on('backToLevel','click', ()=> showSection('step2b'));
on('unitMode','click', ()=> showSection('unitModeSection'));
on('rangeMode','click', ()=> showSection('rangeModeSection'));
on('fullMode','click', ()=> showSection('fullModeSection'));
on('backToModeFromUnit','click', ()=> showSection('step3'));
on('backToModeFromRange','click', ()=> showSection('step3'));
on('backToModeFromFull','click', ()=> showSection('step3'));

// ===== CSV (bank) =====
async function loadLevelCSV(level){
  if(loadedVocab['level'+level]) return loadedVocab['level'+level];
  const res = await fetch('level'+level+'.csv').catch(()=>null);
  if(!res || !res.ok){ alert('Cannot load level'+level+'.csv — place CSV next to this HTML (same origin).'); return []; }
  const text = await res.text();
  const lines = text.trim().split(/\r?\n/);
  const data = lines.slice(1).map(line=>{ const p=line.split(','); if(p.length<6) return null; return {Level:p[0],Unit:p[1],No:p[2],Word:p[3],POS:p[4],Meaning:p.slice(5).join(','),source:'bank'}; }).filter(Boolean);
  loadedVocab['level'+level]=data; return data;
}

function pick(arr,n){ const a=[...arr]; a.sort(()=>0.5-Math.random()); return a.slice(0, Math.min(n,a.length)); }
function selectFromBank(level, mode, opt){ const all=loadedVocab['level'+level]||[]; if(mode==='unit'){ const us=opt.units.map(String); return all.filter(w=>us.includes(w.Unit)); } if(mode==='range'){ const [s,e]=opt.range.split('-').map(Number); const r=all.filter(w=>{const u=+w.Unit; return u>=s&&u<=e;}); return pick(r,opt.count);} if(mode==='full'){ return pick(all,opt.count);} return []; }

on('confirmUnitSelection','click', async ()=>{ const level=$('levelSelect').value; await loadLevelCSV(level); const sel=[...$('unitSelect').selectedOptions].map(o=>o.value); if(sel.length===0){ alert('Select at least one unit'); return;} wordList = selectFromBank(level,'unit',{units:sel}); if(wordList.length===0){ alert('No words'); return;} showModeShortcuts(); });

on('confirmRangeSelection','click', async ()=>{ const level=$('levelSelect').value; const range=$('rangeSelect').value; const count=parseInt($('rangeWordCount').value,10)||10; await loadLevelCSV(level); wordList = selectFromBank(level,'range',{range,count}); if(wordList.length===0){ alert('No words'); return;} showModeShortcuts(); });

on('confirmFullSelection','click', async ()=>{ const level=$('levelSelect').value; const count=parseInt($('fullWordCount').value,10)||10; await loadLevelCSV(level); wordList = selectFromBank(level,'full',{count}); if(wordList.length===0){ alert('No words'); return;} showModeShortcuts(); });

function showModeShortcuts(){ showSection('step1'); const div=document.createElement('div'); div.id='tempModeBtns'; div.innerHTML='<div class="button-group" style="margin-top:12px"><button class="mode-btn" id="tempCognition">Cognition</button><button class="mode-btn" id="tempSpelling">Spelling</button><button class="mode-btn" id="tempDictation">Dictation</button></div>'; const h1=document.querySelector('h1'); h1.parentNode.insertBefore(div,h1.nextSibling); on('tempCognition','click', ()=>{div.remove(); startPractice('cognition');}); on('tempSpelling','click', ()=>{div.remove(); startPractice('spelling');}); on('tempDictation','click', ()=>{div.remove(); startPractice('dictation');}); }

// ===== Quizzes =====
function startPractice(mode){ currentMode=mode; currentIndex=0; correctAnswers=0; wrongAnswers=[]; userAnswers={}; showSection(mode+'Quiz'); if(mode==='cognition') startCognition(); else if(mode==='spelling') startSpelling(); else if(mode==='dictation') startDictation(); }

function startCognition(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('cognitionQuestion').textContent = `${w.Word} (${w.POS})`; $('cognitionResult').textContent=''; const opts = makeOptions(currentIndex); const box=$('cognitionOptions'); box.innerHTML=''; opts.forEach(o=>{ const el=document.createElement('div'); el.className='option'; el.textContent=o; el.onclick=()=>checkCognition(o); box.appendChild(el); }); timeLeft=8; $('cognitionTimer').textContent='Time left: '+timeLeft+'s'; if(timer) clearInterval(timer); timer=setInterval(()=>{ timeLeft--; $('cognitionTimer').textContent='Time left: '+timeLeft+'s'; if(timeLeft<=0){ clearInterval(timer); $('cognitionResult').innerHTML='Time up! Correct: '+wordList[currentIndex].Meaning; wrongAnswers.push(currentIndex); currentIndex++; setTimeout(startCognition, 800); } },1000); }

function makeOptions(i){ const correct=wordList[i].Meaning; const pool=wordList.filter((_,k)=>k!==i); const opts=[correct]; while(opts.length<4 && pool.length){ const r = pool[Math.floor(Math.random()*pool.length)]; if(!opts.includes(r.Meaning)) opts.push(r.Meaning); } return opts.sort(()=>0.5-Math.random()); }
function checkCognition(ans){ clearInterval(timer); const correct=wordList[currentIndex].Meaning; if(ans===correct){ $('cognitionResult').textContent='Correct!'; correctAnswers++; } else { $('cognitionResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex); } currentIndex++; setTimeout(startCognition,800); }

function startSpelling(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('spellingQuestion').textContent='Meaning: '+w.Meaning; $('spellingHint').textContent='POS: '+w.POS+' | First letter: '+w.Word[0].toUpperCase(); $('spellingInput').value=''; $('spellingResult').textContent=''; $('spellingInput').focus(); }
function checkSpelling(){ const user=$('spellingInput').value.trim(); const correct=wordList[currentIndex].Word; userAnswers[currentIndex]=user; if(user.toLowerCase()===correct.toLowerCase()){ $('spellingResult').textContent='Correct!'; correctAnswers++; } else { $('spellingResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex);} currentIndex++; setTimeout(startSpelling,700); }

function startDictation(){ if(currentIndex>=wordList.length){ return showResults(); } const w=wordList[currentIndex]; $('dictationQuestion').textContent='Meaning: '+w.Meaning; $('dictationHint').textContent='POS: '+w.POS; $('dictationInput').value=''; $('dictationResult').textContent=''; setTimeout(()=>{ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(w.Word); u.lang='en-US'; u.rate=.85; speechSynthesis.speak(u);} },300); }
function checkDictation(){ const user=$('dictationInput').value.trim(); const correct=wordList[currentIndex].Word; userAnswers[currentIndex]=user; if(user.toLowerCase()===correct.toLowerCase()){ $('dictationResult').textContent='Correct!'; correctAnswers++; } else { $('dictationResult').textContent='Wrong! Correct: '+correct; wrongAnswers.push(currentIndex);} currentIndex++; setTimeout(startDictation,700); }

on('spellingNext','click', checkSpelling); on('dictationNext','click', checkDictation); on('spellingInput','keypress', e=>{ if(e.key==='Enter') checkSpelling(); }); on('dictationInput','keypress', e=>{ if(e.key==='Enter') checkDictation(); }); on('playAudio','click', ()=>{ const w=wordList[currentIndex]; if(!w) return; if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(w.Word); u.lang='en-US'; u.rate=.85; speechSynthesis.speak(u);} });

function showResults(){
  showSection('resultSection');
  $('progressStats').textContent=`Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}`;
  const list=$('wordList'); list.innerHTML='';
  wordList.forEach((w,i)=>{ const row=document.createElement('div'); row.textContent = `${wrongAnswers.includes(i)?'✗':'✓'}  ${w.Word} (${w.POS}) — ${w.Meaning}`; list.appendChild(row); });
}

// ===== Export helpers =====
function buildResultsText(){
  const lines = [
    `Mode: ${currentMode}`,
    `Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}`,
    ''.padEnd(10,'-')
  ];
  wordList.forEach((w,i)=>{
    const mark = wrongAnswers.includes(i)?'✗':'✓';
    const ans = (currentMode!=='cognition' && userAnswers[i]) ? ` | Your answer: ${userAnswers[i]}` : '';
    lines.push(`${mark} ${w.Word} (${w.POS}) — ${w.Meaning}${ans}`);
  });
  return lines.join('
');
}
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000); }
function generatePrintable(){
  const date = new Date().toLocaleDateString('en-US');
  const map = {cognition:'Cognition', spelling:'Spelling', dictation:'Dictation'};
  const rows = wordList.map((w,i)=>{
    const mark = wrongAnswers.includes(i)?'✗':'✓';
    const ans = currentMode!=='cognition' ? `<td>${userAnswers[i]||''}</td>` : '';
    return `<tr><td>${w.Word}</td><td>${w.POS}</td><td>${w.Meaning}</td>${ans}<td>${mark}</td></tr>`;
  }).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Results</title><style>body{font-family:Arial, sans-serif;margin:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px}th{background:#f5f5f5}@media print{button{display:none}}</style></head><body>
  <h2>Vocabulary Practice Results</h2>
  <p><strong>Class:</strong> ${window.printInfo.cls} | <strong>Seat:</strong> ${window.printInfo.seat} | <strong>Name:</strong> ${window.printInfo.name}</p>
  <p>Date: ${date} | Mode: ${map[currentMode]||currentMode}</p>
  <p>Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}</p>
  <table><thead><tr><th>Word</th><th>POS</th><th>Meaning</th>${currentMode!=='cognition'?'<th>Your Answer</th>':''}<th>Result</th></tr></thead><tbody>${rows}</tbody></table>
  <br><button onclick="window.print()">Print</button> <button onclick="window.close()">Close</button>
  </body></html>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close();
}

// ===== Export bindings =====
on('exportResults','click', ()=>{ const m=$('exportOptions'); if(m) m.style.display='flex'; });
on('closeExport','click', ()=>{ const m=$('exportOptions'); if(m) m.style.display='none'; });
on('copyToClipboard','click', async ()=>{ const txt=buildResultsText(); try{ await navigator.clipboard.writeText(txt); alert('Copied to clipboard'); }catch{ alert('Copy failed. You can download as .txt.'); } });
on('downloadText','click', ()=>{ download('vocab_results.txt', buildResultsText()); });
on('showPrintable','click', ()=>{ const m=$('exportOptions'); if(m) m.style.display='none'; const pf=$('printForm'); if(pf) pf.style.display='flex'; });
on('closePrintForm','click', ()=>{ const pf=$('printForm'); if(pf) pf.style.display='none'; });
on('submitPrintInfo','click', ()=>{ const cls=$('className').value.trim(); const seat=$('seatNo').value.trim(); const name=$('studentName').value.trim(); if(!cls||!seat||!name){ alert('Please fill in all fields.'); return; } window.printInfo={cls,seat,name}; $('printForm').style.display='none'; generatePrintable(); });

on('retryWrong','click', ()=>{ if(wrongAnswers.length===0){ alert('No wrong words!'); return; } wordList = wrongAnswers.map(i=>wordList[i]); currentIndex=0; correctAnswers=0; wrongAnswers=[]; userAnswers={}; showSection(currentMode+'Quiz'); if(currentMode==='cognition') startCognition(); else if(currentMode==='spelling') startSpelling(); else if(currentMode==='dictation') startDictation(); });

on('backToInput','click', ()=> showSection('step1'));

// ===== boot =====
initUnitSelect();
console.log('[boot] ready');
</script>
</body>
</html>
