<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Shirley's Vocab Online Self-Practice</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            color: #2c2c2c;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: white;
            padding: 32px;
            border-radius: 22px;
            box-shadow: 0 14px 45px rgba(0, 0, 0, 0.25);
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 32px;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.8px;
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 28px 0 20px;
            color: #1a1a1a;
            border-bottom: 3px solid #00c6ff;
            padding-bottom: 10px;
            text-align: center;
        }
        .control-group {
            margin-bottom: 24px;
            text-align: center;
        }
        label {
            display: block;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a1a1a;
        }
        select, input[type="number"], textarea {
            width: 100%;
            max-width: 500px;
            padding: 16px;
            font-size: 1.15rem;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            background: white;
            outline: none;
            transition: all 0.25s ease;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
        }
        select:focus, input[type="number"]:focus, textarea:focus {
            border-color: #00c6ff;
            box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.25), inset 0 2px 6px rgba(0,0,0,0.08);
        }
        textarea {
            min-height: 180px;
            resize: vertical;
            font-family: inherit;
        }
        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 32px 0;
        }
        button {
            padding: 16px 32px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.25s ease;
            min-width: 180px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            letter-spacing: 0.5px;
        }
        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 22px rgba(0,0,0,0.22);
        }
        button:active {
            transform: translateY(0);
        }
        .mode-button {
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            color: white;
        }
        #fullLevelBtn {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white;
        }
        #fullLevelBtn:hover {
            background: linear-gradient(135deg, #e0325b, #e03e25);
        }
        #wordSourceSection, #cognitionQuiz, #spellingQuiz, #dictationQuiz, #resultSection {
            display: none;
        }
        @media (max-width: 768px) {
            .container {
                padding: 24px 20px;
            }
            h1 {
                font-size: 2.1rem;
            }
            button {
                padding: 14px 24px;
                font-size: 1.1rem;
                min-width: 150px;
                flex: 1;
            }
            .button-group {
                gap: 14px;
            }
            select, input[type="number"], textarea {
                font-size: 1.1rem;
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shirley's Vocab Online Self-Practice</h1>

        <!-- Word Source Selection -->
        <div id="wordSourceSection">
            <h2 class="section-title">Select Word Source</h2>
            <div class="control-group">
                <label for="wordSource">Choose Input Method</label>
                <select id="wordSource">
                    <option value="manual">Enter Your Words</option>
                    <option value="level">Select Vocabulary Level</option>
                </select>
            </div>

            <!-- Manual Input -->
            <div id="manualInputSection">
                <h2 class="section-title">Enter Your Words</h2>
                <p style="text-align:center; margin-top:0; color:#555; font-size:1.1rem;">
                    Format: <code>word POS Meaning</code> (one per line)
                </p>
                <textarea id="wordInput" placeholder="Example:
apple n. apple
run v. run
beautiful adj. beautiful"></textarea>
            </div>

            <!-- Vocabulary Level Selection -->
            <div id="levelInputSection" style="display:none;">
                <h2 class="section-title">Select Vocabulary Level</h2>
                <div class="control-group">
                    <label for="vocabLevel">Level</label>
                    <select id="vocabLevel">
                        <option value="level1">Level 1</option>
                        <option value="level2">Level 2</option>
                        <option value="level3">Level 3</option>
                        <option value="level4">Level 4</option>
                        <option value="level5">Level 5</option>
                        <option value="level6">Level 6</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="unitsSelect">Select Units (1–50)</label>
                    <select id="unitsSelect" multiple size="5" style="height:120px;">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="control-group">
                    <label for="rangeStart">Select Range & Count</label>
                    <div style="display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
                        <input type="number" id="rangeStart" min="1" max="1000" value="1" style="max-width:120px;"/>
                        <span style="align-self:center;">to</span>
                        <input type="number" id="rangeEnd" min="1" max="1000" value="10" style="max-width:120px;"/>
                    </div>
                </div>
                <div style="text-align:center; margin-top:16px;">
                    <button id="fullLevelBtn">Full Level Practice</button>
                </div>
            </div>

            <h2 class="section-title">Select Practice Mode</h2>
            <div class="button-group">
                <button class="mode-button" id="cognitionMode">Recognition Mode</button>
                <button class="mode-button" id="spellingMode">Spelling Practice</button>
                <button class="mode-button" id="dictationMode">Dictation Practice</button>
            </div>
        </div>

        <!-- Recognition Quiz -->
        <div id="cognitionQuiz">
            <h2 class="section-title">Recognition Mode</h2>
            <div id="cognitionTimer" style="font-size:1.4rem; margin:20px 0; padding:14px 28px; background:#fff8e1; color:#ff6f00; border-radius:14px; font-weight:700; display:inline-block;"></div>
            <div id="cognitionQuestion" style="font-size:2.1rem; margin:24px 0; font-weight:800;"></div>
            <div id="cognitionOptions" style="display:grid; grid-template-columns:repeat(2,1fr); gap:20px; margin:28px 0;"></div>
            <div id="cognitionResult"></div>
        </div>

        <!-- Spelling Quiz -->
        <div id="spellingQuiz">
            <h2 class="section-title">Spelling Practice</h2>
            <div id="spellingQuestion" style="font-size:2.1rem; margin:24px 0; font-weight:800;"></div>
            <div id="spellingHint" style="font-size:1.25rem; margin:20px 0; padding:16px; background:#f0f9ff; color:#0d47a1; border-radius:14px; font-weight:600; border-left:4px solid #00c6ff;"></div>
            <input type="text" id="spellingInput" placeholder="Type the word in English" style="width:100%; max-width:500px; padding:18px; font-size:1.4rem; text-align:center; border:2px solid #e0e0e0; border-radius:14px; margin:22px auto; display:block; font-weight:600;"/>
            <div style="text-align:center;">
                <button id="spellingNext" style="background:linear-gradient(135deg, #00b09b, #96c93d); color:white; padding:16px 32px; border:none; border-radius:16px; font-size:1.2rem; font-weight:700; cursor:pointer;">Next</button>
            </div>
            <div id="spellingResult" style="margin:22px 0;"></div>
        </div>

        <!-- Dictation Quiz -->
        <div id="dictationQuiz">
            <h2 class="section-title">Dictation Practice</h2>
            <div id="dictationQuestion" style="font-size:2.1rem; margin:24px 0; font-weight:800;"></div>
            <div id="dictationHint" style="font-size:1.25rem; margin:20px 0; padding:16px; background:#f0f9ff; color:#0d47a1; border-radius:14px; font-weight:600; border-left:4px solid #00c6ff;"></div>
            <div style="text-align:center; margin:18px 0;">
                <button id="playAudio" style="background:linear-gradient(135deg, #ff416c, #ff4b2b); color:white; padding:16px 32px; border:none; border-radius:16px; font-size:1.2rem; font-weight:700; cursor:pointer;">Play Audio</button>
            </div>
            <input type="text" id="dictationInput" placeholder="Type the word you heard" style="width:100%; max-width:500px; padding:18px; font-size:1.4rem; text-align:center; border:2px solid #e0e0e0; border-radius:14px; margin:22px auto; display:block; font-weight:600;"/>
            <div style="text-align:center;">
                <button id="dictationNext" style="background:linear-gradient(135deg, #00b09b, #96c93d); color:white; padding:16px 32px; border:none; border-radius:16px; font-size:1.2rem; font-weight:700; cursor:pointer;">Next</button>
            </div>
            <div id="dictationResult" style="margin:22px 0;"></div>
        </div>

        <!-- Results Section -->
        <div id="resultSection">
            <h2 class="section-title">Practice Results</h2>
            <div id="progressStats" style="font-size:1.3rem; margin:26px 0; padding:18px; background:#f5f9ff; border-radius:16px; font-weight:700; color:#0d47a1; border:1px solid #cbe5ff; text-align:center;"></div>
            <div id="wordList" style="max-height:420px; overflow-y:auto; border-radius:14px; border:1px solid #e0e0e0; background:#fcfcfc; margin-top:24px;"></div>
            <div class="button-group">
                <button id="exportResults">Export Results</button>
                <button id="retryWrong">Retry Wrong Words</button>
                <button id="backToInput">Back to Input</button>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let wordList = [];
        let currentMode = '';
        let currentIndex = 0;
        let correctAnswers = 0;
        let wrongAnswers = [];
        let timer;
        let timeLeft = 8;
        let audioQueue = [];
        let isPlayingAudio = false;
        let userAnswers = {};
        let selectedUnits = new Set();

        // DOM 元素
        const wordSourceSection = document.getElementById('wordSourceSection');
        const manualInputSection = document.getElementById('manualInputSection');
        const levelInputSection = document.getElementById('levelInputSection');
        const wordSource = document.getElementById('wordSource');
        const vocabLevel = document.getElementById('vocabLevel');
        const unitsSelect = document.getElementById('unitsSelect');
        const rangeStart = document.getElementById('rangeStart');
        const rangeEnd = document.getElementById('rangeEnd');
        const fullLevelBtn = document.getElementById('fullLevelBtn');
        const wordInput = document.getElementById('wordInput');

        const cognitionModeBtn = document.getElementById('cognitionMode');
        const spellingModeBtn = document.getElementById('spellingMode');
        const dictationModeBtn = document.getElementById('dictationMode');

        const cognitionQuiz = document.getElementById('cognitionQuiz');
        const spellingQuiz = document.getElementById('spellingQuiz');
        const dictationQuiz = document.getElementById('dictationQuiz');
        const resultSection = document.getElementById('resultSection');

        const cognitionQuestion = document.getElementById('cognitionQuestion');
        const cognitionOptions = document.getElementById('cognitionOptions');
        const cognitionTimer = document.getElementById('cognitionTimer');
        const cognitionResult = document.getElementById('cognitionResult');

        const spellingQuestion = document.getElementById('spellingQuestion');
        const spellingHint = document.getElementById('spellingHint');
        const spellingInput = document.getElementById('spellingInput');
        const spellingNext = document.getElementById('spellingNext');
        const spellingResult = document.getElementById('spellingResult');

        const dictationQuestion = document.getElementById('dictationQuestion');
        const dictationHint = document.getElementById('dictationHint');
        const dictationInput = document.getElementById('dictationInput');
        const dictationNext = document.getElementById('dictationNext');
        const playAudio = document.getElementById('playAudio');
        const dictationResult = document.getElementById('dictationResult');

        const progressStats = document.getElementById('progressStats');
        const wordListElement = document.getElementById('wordList');
        const exportResultsBtn = document.getElementById('exportResults');
        const retryWrongBtn = document.getElementById('retryWrong');
        const backToInputBtn = document.getElementById('backToInput');

        // 初始顯示 word source
        wordSourceSection.style.display = 'block';

        // Word source 切換
        wordSource.addEventListener('change', () => {
            if (wordSource.value === 'manual') {
                manualInputSection.style.display = 'block';
                levelInputSection.style.display = 'none';
            } else {
                manualInputSection.style.display = 'none';
                levelInputSection.style.display = 'block';
            }
        });

        // Full Level Practice
        fullLevelBtn.addEventListener('click', async () => {
            const level = vocabLevel.value;
            try {
                const response = await fetch(`${level}.csv`);
                const csvText = await response.text();
                wordInput.value = csvText;
                manualInputSection.style.display = 'block';
                levelInputSection.style.display = 'none';
                wordSource.value = 'manual';
            } catch (error) {
                alert(`Failed to load ${level}.csv`);
            }
        });

        // Units selection logic (optional – you may already have this)
        vocabLevel.addEventListener('change', populateUnits);
        function populateUnits() {
            unitsSelect.innerHTML = '';
            for (let i = 1; i <= 50; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Unit ${i}`;
                unitsSelect.appendChild(option);
            }
        }
        populateUnits();

        // Practice mode buttons
        cognitionModeBtn.addEventListener('click', () => startQuiz('cognition'));
        spellingModeBtn.addEventListener('click', () => startQuiz('spelling'));
        dictationModeBtn.addEventListener('click', () => startQuiz('dictation'));

        spellingNext.addEventListener('click', checkSpellingAnswer);
        dictationNext.addEventListener('click', checkDictationAnswer);
        playAudio.addEventListener('click', playDictationAudio);
        exportResultsBtn.addEventListener('click', showExportOptions);
        retryWrongBtn.addEventListener('click', retryWrongWords);
        backToInputBtn.addEventListener('click', backToInput);

        spellingInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkSpellingAnswer();
        });
        dictationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkDictationAnswer();
        });

        // ======================
        // Remaining functions (identical to your original logic)
        // ======================

        function startQuiz(mode) {
            const input = wordInput.value.trim();
            if (!input) {
                alert('Please enter word list!');
                return;
            }
            wordList = parseWordInput(input);
            if (wordList.length === 0) {
                alert('Please enter valid format!');
                return;
            }
            currentMode = mode;
            currentIndex = 0;
            correctAnswers = 0;
            wrongAnswers = [];
            userAnswers = {};

            wordSourceSection.style.display = 'none';
            cognitionQuiz.style.display = 'none';
            spellingQuiz.style.display = 'none';
            dictationQuiz.style.display = 'none';
            resultSection.style.display = 'none';

            if (mode === 'cognition') {
                cognitionQuiz.style.display = 'block';
                startCognitionQuiz();
            } else if (mode === 'spelling') {
                spellingQuiz.style.display = 'block';
                startSpellingQuiz();
            } else if (mode === 'dictation') {
                dictationQuiz.style.display = 'block';
                startDictationQuiz();
            }
        }

        function parseWordInput(input) {
            const lines = input.split('\n');
            const words = [];
            for (let line of lines) {
                line = line.trim();
                if (!line || line.startsWith('#')) continue;
                const parts = line.split(/\s+/);
                if (parts.length >= 3) {
                    const word = parts[0];
                    const pos = parts[1];
                    const meaning = parts.slice(2).join(' ');
                    words.push({ word, pos, meaning });
                }
            }
            return words;
        }

        function startCognitionQuiz() {
            if (currentIndex >= wordList.length) {
                showResults();
                return;
            }
            const currentWord = wordList[currentIndex];
            cognitionQuestion.textContent = `${currentWord.word} (${currentWord.pos})`;
            cognitionResult.innerHTML = '';

            const options = generateOptions(currentIndex);
            cognitionOptions.innerHTML = '';
            options.forEach(option => {
                const el = document.createElement('div');
                el.style.padding = '22px';
                el.style.background = '#f8fbff';
                el.style.border = '2px solid #d0e4ff';
                el.style.borderRadius = '16px';
                el.style.cursor = 'pointer';
                el.style.fontSize = '1.3rem';
                el.style.fontWeight = '600';
                el.style.textAlign = 'center';
                el.textContent = option;
                el.addEventListener('click', () => checkCognitionAnswer(option));
                cognitionOptions.appendChild(el);
            });

            timeLeft = 8;
            cognitionTimer.textContent = `Time Left: ${timeLeft}s`;
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                cognitionTimer.textContent = `Time Left: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    handleTimeout();
                }
            }, 1000);
        }

        function generateOptions(correctIndex) {
            const options = [wordList[correctIndex].meaning];
            while (options.length < 4) {
                const idx = Math.floor(Math.random() * wordList.length);
                if (idx !== correctIndex && !options.includes(wordList[idx].meaning)) {
                    options.push(wordList[idx].meaning);
                }
            }
            return shuffleArray(options);
        }

        function shuffleArray(a) {
            const arr = [...a];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function checkCognitionAnswer(answer) {
            clearInterval(timer);
            const current = wordList[currentIndex];
            const correct = answer === current.meaning;
            userAnswers[currentIndex] = answer;
            if (correct) {
                cognitionResult.innerHTML = '<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#e8f5e9; color:#2e7d32; border-left:5px solid #4caf50;">Correct!</div>';
                correctAnswers++;
            } else {
                cognitionResult.innerHTML = `<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#ffebee; color:#c62828; border-left:5px solid #f44336;">Wrong! Correct answer: ${current.meaning}</div>`;
                wrongAnswers.push(currentIndex);
            }
            currentIndex++;
            setTimeout(startCognitionQuiz, 1500);
        }

        function handleTimeout() {
            const current = wordList[currentIndex];
            cognitionResult.innerHTML = `<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#ffebee; color:#c62828; border-left:5px solid #f44336;">Time’s up! Correct answer: ${current.meaning}</div>`;
            wrongAnswers.push(currentIndex);
            currentIndex++;
            setTimeout(startCognitionQuiz, 1500);
        }

        function startSpellingQuiz() {
            if (currentIndex >= wordList.length) {
                showResults();
                return;
            }
            const current = wordList[currentIndex];
            spellingQuestion.textContent = `Meaning: ${current.meaning}`;
            spellingHint.textContent = `POS: ${current.pos} | First letter: ${current.word[0].toUpperCase()}`;
            spellingInput.value = '';
            spellingResult.innerHTML = '';
            spellingInput.focus();
        }

        function checkSpellingAnswer() {
            const current = wordList[currentIndex];
            const ans = spellingInput.value.trim();
            const correct = ans.toLowerCase() === current.word.toLowerCase();
            userAnswers[currentIndex] = ans;
            if (correct) {
                spellingResult.innerHTML = '<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#e8f5e9; color:#2e7d32; border-left:5px solid #4caf50;">Correct!</div>';
                correctAnswers++;
            } else {
                spellingResult.innerHTML = `<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#ffebee; color:#c62828; border-left:5px solid #f44336;">Wrong! Correct answer: ${current.word}</div>`;
                wrongAnswers.push(currentIndex);
            }
            currentIndex++;
            setTimeout(startSpellingQuiz, 1500);
        }

        function startDictationQuiz() {
            if (currentIndex >= wordList.length) {
                showResults();
                return;
            }
            const current = wordList[currentIndex];
            dictationQuestion.textContent = `Meaning: ${current.meaning}`;
            dictationHint.textContent = `POS: ${current.pos}`;
            dictationInput.value = '';
            dictationResult.innerHTML = '';
            audioQueue = [current.word, current.word];
            isPlayingAudio = false;
            playDictationAudio();
            if (window.autoNextTimer) clearTimeout(window.autoNextTimer);
            window.autoNextTimer = setTimeout(checkDictationAnswer, 5000);
        }

        function playDictationAudio() {
            if (isPlayingAudio || audioQueue.length === 0) return;
            isPlayingAudio = true;
            const word = audioQueue.shift();
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(word);
                u.lang = 'en-US';
                u.rate = 0.8;
                u.onend = () => {
                    isPlayingAudio = false;
                    if (audioQueue.length > 0) setTimeout(playDictationAudio, 1000);
                };
                speechSynthesis.speak(u);
            } else {
                alert('Your browser does not support speech synthesis.');
                isPlayingAudio = false;
            }
        }

        function checkDictationAnswer() {
            if (window.autoNextTimer) clearTimeout(window.autoNextTimer);
            const current = wordList[currentIndex];
            const ans = dictationInput.value.trim();
            const correct = ans.toLowerCase() === current.word.toLowerCase();
            userAnswers[currentIndex] = ans;
            if (correct) {
                dictationResult.innerHTML = '<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#e8f5e9; color:#2e7d32; border-left:5px solid #4caf50;">Correct!</div>';
                correctAnswers++;
            } else {
                dictationResult.innerHTML = `<div style="margin:22px 0; padding:18px; border-radius:14px; font-size:1.4rem; font-weight:700; background:#ffebee; color:#c62828; border-left:5px solid #f44336;">Wrong! Correct answer: ${current.word}</div>`;
                wrongAnswers.push(currentIndex);
            }
            currentIndex++;
            setTimeout(startDictationQuiz, 1500);
        }

        function showResults() {
            cognitionQuiz.style.display = 'none';
            spellingQuiz.style.display = 'none';
            dictationQuiz.style.display = 'none';
            resultSection.style.display = 'block';

            progressStats.textContent = `Total: ${wordList.length} words | Correct: ${correctAnswers} | Wrong: ${wrongAnswers.length}`;

            wordListElement.innerHTML = '';
            wordList.forEach((word, idx) => {
                const item = document.createElement('div');
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.padding = '18px 22px';
                item.style.borderBottom = '1px solid #eee';
                item.style.alignItems = 'center';

                const info = document.createElement('div');
                info.style.flex = '1';
                info.style.textAlign = 'left';
                info.style.fontSize = '1.2rem';
                info.innerHTML = `<strong>${word.word}</strong> (${word.pos}) - ${word.meaning}`;
                if ((currentMode === 'spelling' || currentMode === 'dictation') && userAnswers[idx]) {
                    const ua = document.createElement('span');
                    ua.style.color = '#ff6d00';
                    ua.style.marginLeft = '12px';
                    ua.style.fontWeight = '600';
                    ua.textContent = `Your answer: ${userAnswers[idx]}`;
                    info.appendChild(ua);
                }

                const mark = document.createElement('span');
                mark.style.fontSize = '1.6rem';
                mark.style.fontWeight = 'bold';
                if (wrongAnswers.includes(idx)) {
                    mark.textContent = '✗';
                    mark.style.color = '#f44336';
                } else {
                    mark.textContent = '✓';
                    mark.style.color = '#4caf50';
                }

                item.appendChild(info);
                item.appendChild(mark);
                wordListElement.appendChild(item);
            });
        }

        function showExportOptions() {
            const choice = prompt('Export as:\n1. Copy to clipboard\n2. Download text\n3. Print\nEnter 1, 2, or 3');
            if (choice === '1') copyToClipboard();
            else if (choice === '2') downloadAsText();
            else if (choice === '3') printResults();
        }

        function copyToClipboard() {
            let text = `Vocabulary Practice Results\nDate: ${new Date().toLocaleDateString()}\nMode: ${currentMode}\nTotal: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}\n\n`;
            wordList.forEach((w, i) => {
                text += `${w.word} (${w.pos}) - ${w.meaning}`;
                if (userAnswers[i]) text += ` | Your answer: ${userAnswers[i]}`;
                text += ` | ${wrongAnswers.includes(i) ? '✗ Wrong' : '✓ Correct'}\n`;
            });
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }

        function downloadAsText() {
            let text = `Vocabulary Practice Results\nDate: ${new Date().toLocaleDateString()}\nMode: ${currentMode}\nTotal: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}\n\n`;
            wordList.forEach((w, i) => {
                text += `${w.word} (${w.pos}) - ${w.meaning}`;
                if (userAnswers[i]) text += ` | Your answer: ${userAnswers[i]}`;
                text += ` | ${wrongAnswers.includes(i) ? '✗ Wrong' : '✓ Correct'}\n`;
            });
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vocab_results_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function printResults() {
            const printWin = window.open('', '_blank');
            printWin.document.write(`
                <html><head><title>Results</title></head><body>
                <h1>Vocabulary Practice Results</h1>
                <p>Date: ${new Date().toLocaleDateString()}</p>
                <p>Total: ${wordList.length}, Correct: ${correctAnswers}, Wrong: ${wrongAnswers.length}</p>
                <pre>${wordList.map((w,i)=>`${w.word} (${w.pos}) - ${w.meaning} | ${userAnswers[i]||''} | ${wrongAnswers.includes(i)?'✗':'✓'}`).join('\n')}</pre>
                <button onclick="window.print()">Print</button>
                </body></html>
            `);
            printWin.document.close();
        }

        function retryWrongWords() {
            if (wrongAnswers.length === 0) {
                alert('No wrong words to retry!');
                return;
            }
            wordList = wrongAnswers.map(i => wordList[i]);
            currentIndex = 0;
            correctAnswers = 0;
            wrongAnswers = [];
            userAnswers = {};

            if (currentMode === 'cognition') {
                cognitionQuiz.style.display = 'block';
                resultSection.style.display = 'none';
                startCognitionQuiz();
            } else if (currentMode === 'spelling') {
                spellingQuiz.style.display = 'block';
                resultSection.style.display = 'none';
                startSpellingQuiz();
            } else if (currentMode === 'dictation') {
                dictationQuiz.style.display = 'block';
                resultSection.style.display = 'none';
                startDictationQuiz();
            }
        }

        function backToInput() {
            resultSection.style.display = 'none';
            wordSourceSection.style.display = 'block';
        }
    </script>
</body>
</html>
